<include file="../public/header_dialog" />
{$usejs}

<div class="so_main">

  <div class="page_tit">消息推送管理</div>
  <div class="tit_tab">
	<ul>
		<li><a class=on href="#">添加消息推送</a></li>
	</ul>
  </div>

<table border="0" cellspacing="0" cellpadding="0" style="width:900px;">
<tr>
<td>
<!--/dialog_start-->

<form method="post" id="act_form" name="act_form" action="{:U('admin/push_message/push_message_add_action')}" enctype="multipart/form-data">
	<table class="add_table" border="0" cellspacing="0" cellpadding="0" >
		<tbody>
				
				<tr>
					<th width="15%">推送平台：</th>
					<td width="80%">
						<select name="field_uid" id="field_uid"  style="width:100px;">
							<option value="">请选择</option>
							{$app_list}
						</select>
						<script>set_select_value(document.act_form.field_uid,"{$data.field_uid}");</script>
					</td>
				</tr>

				<tr>
					<th>客户端类型：</th>
					<td>
						<select name="message_type"  style="width:100px;">
							<option value="">请选择</option>
							<option value="android">android</option>
							<option value="ios">ios</option>
						</select>
						<script>set_select_value(document.act_form.message_type,"<php> echo get('message_type');</php>");</script>
					</td>
				</tr>
				<tr>
					<th>发送范围：</th>
					<td>
						<select name="receiver_type" style="width:100px;" onchange="load_type_info(this.value);">
							<option value="">请选择</option>
							<option value="4">所有用户</option>
							<option value="3"  selected>指定用户</option>
							<option value="5">指定赛事</option>
						</select>
						
					</td>
				</tr>
				<tr class="select_event" style="display:none;">
					<th>赛事列表：</th>
					<td>
						
					</td>
				</tr>
				<tr class="select_fenzhan" style="display:none;">
					<th>分站列表：</th>
					<td>
						
					</td>
				</tr>
		
				<tr>
					<th>消息内容：</th>
					<td><textarea name="n_content" id="n_content" class="mod_input2" style="width:400px; height:100px;">{$data.n_content}</textarea><br />IOS：最多26个汉字，不能超过这个长度，否则不能发送。</td>
				</tr>
				<tr>
					<th>消息图片：</th>
					<td><input type="file" name="message_pic" id="message_pic" class="mod_input2" style="width:300px;" ></td>
				</tr>
	
				<tr id="type_3">
					<th>目标用户：</th>
					<td style="width:500px;">
						<div>
							<span>用户UID：</span><input type="text" name="uid" id="uid" class="mod_input2" style="width:100px;"  value="{$data.uid}">
						</div>
						<div style="padding-top:10px;">
							<p>根据用户名搜索UID：</p>
							<p>
							<iframe src="{:U('admin/push_message/user_tool')}" style="border:1px solid #ccc;" width="300" height="50">
							</iframe>
							</p>
						</div>
					</td>
				</tr>
				<tr class="type_4">
					<th>扩展信息：</th>
					<td>
						<select name="ext_action" style="width:100px;">
							<option value="">请选择</option>
							{$action_list}
						</select>
					</td>
				</tr>
				<tr class="type_4">
					<th></th>
					<td>
						<input type="text" name="ext_id" id="ext_id" class="mod_input2" style="width:100px;"  value="{$data.ext_id}">（相应ID：赛事直播sid   /  博客blogid / 论坛详细event_id / 图片库详细 album_id）
					</td>
				</tr>
				<tr class="type_4">
					<th></th>
					<td>
						<input type="text" name="ext_title" id="ext_title" class="mod_input2" style="width:100px;"  value="{$data.ext_title}">（相应TITLE，当扩展信息为WAP是此处填写wap地址）
					</td>
				</tr>
				</tbody>
		<tfoot>
			<tr>
				<th></th>
				<td>
					<input type="hidden" name="message_id" value="{$data.message_id}">
					<input type="submit" class="btn_b" value="保存" style="margin-right:10px;"/>
					<input type="button" class="btn_w" onclick="javascript:history.back(-1);" value="取消" />
				</td>
		</tfoot>
	</table><!--/add_table-->
</form>

<script>
$(document).ready(function(){
$.formValidator.initConfig({formID:"act_form",theme:'ArrowSolidBox',mode:'AutoTip',onError:function(msg){msg_error(msg)},inIframe:true});

	$("#message_number").formValidator({empty:true,onShow:"请输入消息编号",onFocus:"请输入消息编号",onCorrect:"输入正确"}).inputValidator({min:1,max:50,onError:"请输入消息编号"});
	$("#message_type").formValidator({empty:true,onShow:"请输入推送平台",onFocus:"请输入推送平台",onCorrect:"输入正确"}).inputValidator({min:1,max:50,onError:"请输入推送平台"});
	$("#uid").formValidator({empty:true,onShow:"请输入目标用户",onFocus:"请输入目标用户",onCorrect:"输入正确"}).inputValidator({min:1,max:11,onError:"请输入目标用户"});
	$("#message_title").formValidator({empty:true,onShow:"请输入消息标题",onFocus:"请输入消息标题",onCorrect:"输入正确"}).inputValidator({min:1,max:50,onError:"请输入消息标题"});
	$("#message_content").formValidator({empty:true,onShow:"请输入消息内容",onFocus:"请输入消息内容",onCorrect:"输入正确"}).inputValidator({min:1,max:500,onError:"请输入消息内容"});
	$("#devices_token").formValidator({empty:true,onShow:"请输入设备编号",onFocus:"请输入设备编号",onCorrect:"输入正确"}).inputValidator({min:1,max:50,onError:"请输入设备编号"});
	$("#message_state").formValidator({empty:true,onShow:"请输入消息状态",onFocus:"请输入消息状态",onCorrect:"输入正确"}).inputValidator({min:1,max:11,onError:"请输入消息状态"});
	$("#receiver_type").formValidator({empty:true,onShow:"请输入发送范围",onFocus:"请输入发送范围",onCorrect:"输入正确"}).inputValidator({min:1,max:11,onError:"请输入发送范围"});
	$("#message_totalnum").formValidator({empty:true,onShow:"请输入共需发送",onFocus:"请输入共需发送",onCorrect:"输入正确"}).inputValidator({min:1,max:11,onError:"请输入共需发送"});
	$("#message_sendnum").formValidator({empty:true,onShow:"请输入总发送数",onFocus:"请输入总发送数",onCorrect:"输入正确"}).inputValidator({min:1,max:11,onError:"请输入总发送数"});
	$("#message_errorcode").formValidator({empty:true,onShow:"请输入错误代码",onFocus:"请输入错误代码",onCorrect:"输入正确"}).inputValidator({min:1,max:50,onError:"请输入错误代码"});
	$("#message_errormsg").formValidator({empty:true,onShow:"请输入错误信息",onFocus:"请输入错误信息",onCorrect:"输入正确"}).inputValidator({min:1,max:50,onError:"请输入错误信息"});
	$("#message_sendtime").formValidator({empty:true,onShow:"请输入发送时间",onFocus:"请输入发送时间",onCorrect:"输入正确"}).inputValidator({min:1,max:10,onError:"请输入发送时间"});
		

	$.formValidator.reloadAutoTip();
});

function reloadAutoTip()
{
	$.formValidator.reloadAutoTip();
}


function load_type_info(obj)
{
	//alert(obj);
	$(".type_4").show();
	$(".select_event").hide();
	$(".select_fenzhan").hide();
	$(".select_event td").html('');
	$(".select_fenzhan td").html('');
	if(obj==4)
	{
		$("#type_3").hide();
	}else if(obj==5){
		$("#type_3").hide();
		var field_uid = $("#field_uid").val();
		if(field_uid == ''){
			alert('请选择球场');
			return false;
		}
		$.ajax({
			 type: 'GET',
			 url: '/default.php?g=admin&m=push_message&a=get_event_list_ajax&field_uid='+field_uid,
			 dataType: 'json',
			 success: function(json){
				if(json.status == 0){
					//alert(json.info);return false;
				}
				var event_list_str = '<select name="event_id" id="evnet_id" style="width:100px;" onchange="load_fenzhan_list(this.value);"><option value="">请选择</option>';
				var event_list = json.data;
				for(var i in event_list){
					event_list_str+= '<option value="'+event_list[i]['event_id']+'">'+event_list[i]['event_name']+'</option>';
				}
				event_list_str += '</select>';
				$(".select_event td").append($(event_list_str));
			 }
		});
		$(".select_event").show();
	}
	else
	{
		$("#type_3").show();
		//$("#type_4").css("display","none");
	}
	
}
function load_fenzhan_list(event_id)
{
	if(event_id!='')
	{
		$.ajax({
			 type: 'GET',
			 url: '/default.php?g=admin&m=push_message&a=get_fenzhan_list_ajax&evnet_id='+event_id,
			 dataType: 'json',
			 success: function(json){
				if(json.status == 0){
					//alert(json.info);
					return false;
				}
				var fenzhan_list_str = '<select name="fenzhan_id" id="fenzhan_id" style="width:100px;"><option value="">请选择</option>';
				var fenzhan_list = json.data;
				for(var i in fenzhan_list){
					fenzhan_list_str+= '<option value="'+event_list[i]['event_id']+'">'+event_list[i]['event_name']+'</option>';
				}
				fenzhan_list_str += '</select>';
				$(".select_fenzhan td").append($(fenzhan_list_str));
				$(".select_fenzhan").show();
			 }
		});
	}
	else
	{
		$(".select_fenzhan").hide();
	}
	
}

</script>

<!--/dialog_end-->
</td>
</tr>
</table>

</div>
<include file="../public/_footer" />
